<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presentation</title>
</head>

<body>
    <div id="register">
        <input type="text" id="inpUserCreate" placeholder="Username">
        <input type="text" id="inpEmailCreate" placeholder="E-mail">    
        <input type="password" id="inpPasswordCreate" placeholder="Password">
        <br><br>
        <button id="btnCreate">Create user</button>
        <h3 id="txtResultCreate"></h3>
    </div>

    <div id="login">
        <input type="text" id="inpEmailLogin" placeholder="E-mail">
        <input type="password" id="inpPasswordLogin" placeholder="Password">
        <br><br>
        <button id="btnLogin">Login</button>
        <h3 id="txtResultLogin"></h3>
    </div>

    <div id="update">
        <input type="text" id="inpUserUpdate" placeholder="Update username">
        <input type="text" id="inpEmailUpdate" placeholder="Update email">
        <input type="text" id="inpPassUpdate" placeholder="Update password">
        <br><br>
        <button id="btnUpdate">Update</button>
        <h3 id="txtResultUpdate"></h3>
    </div>
    
</body>

<script>
    let inpUserCreate = document.getElementById('inpUserCreate');
    let inpEmailCreate = document.getElementById('inpEmailCreate');    
    let inpPasswordCreate = document.getElementById('inpPasswordCreate');
    let btnCreate = document.getElementById('btnCreate');
    let txtResultCreate = document.getElementById('txtResultCreate');

    let inpEmailLogin = document.getElementById('inpEmailLogin');
    let inpPasswordLogin = document.getElementById('inpPasswordLogin');
    let btnLogin = document.getElementById('btnLogin');
    let txtResultLogin = document.getElementById('txtResultLogin');

    let inpUserUpdate = document.getElementById('inpUserUpdate');
    let inpEmailUpdate = document.getElementById('inpEmailUpdate');    
    let inpPasswordUpdate = document.getElementById('inpPasswordUpdate');
    let btnUpdate = document.getElementById('btnUpdate');
    let txtResultUpdate = document.getElementById('txtResultUpdate');

    btnCreate.addEventListener('click', function(evt) {
        if(!validUsername(inpUserCreate)){
            txtResultCreate.innerHTML = "Wrong username format. Use only letters, digits and underscores.";
        }
        else if(!validEmail(inpEmailCreate)){
            txtResultCreate.innerHTML = "Wrong email format.";
        }
        else if(!validPassword(inpPasswordCreate)){
            txtResultCreate.innerHTML = "Wrong password format. Password must be at least 4 characters long and should not contain empty spaces";
        }
        else{
            createUser();
        }
    });
    
    btnLogin.addEventListener('click', function(evt){
        if(!validEmail(inpEmailLogin)){
            txtResultLogin.innerHTML = "Wrong format for email.";
        }
        else if(!validPassword(inpPasswordLogin)){
            txtResultLogin.innerHTML = "Wrong password format. Password must be at least 4 characters long and should not contain empty spaces";
        }
        else{
            loginUser();
        }
    });

    btnUpdate.addEventListener('click', function(evt){
        if(!validUsername(inpUserUpdate)){
            txtResultUpdate.innerHTML = "Wrong username format. Use only letters, digits and underscores.";
        }
        else if(!validEmail(inpEmailUpdate)){
            txtResultUpdate.innerHTML = "Wrong email format.";
        }
        else if(!validPassword(inpPasswordUpdate)){
            txtResultUpdate.innerHTML = "Wrong password format. Password must be at least 4 characters long and should not contain empty spaces";
        }
        else{
            updateUser();
        }
    });

    //-----------------------------------------
    async function createUser(){

        let url = "/user";

        let updata = {
            name: inpUserCreate.value,
            email: inpEmailCreate.value,
            password: inpPasswordCreate.value            
        }

        let cfg = {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify(updata)
        }

        try {
            let resp = await fetch(url, cfg);
            let data = await resp.json();
            txtResultCreate.innerHTML = data.msg; 
        }
        catch (err) {
            console.log(err);
        }
    }

    //-----------------------------------------
    async function loginUser(){

        let url = "/auth"; //check url again with server when the API is finished

        let updata = {
            emailLogin: inpEmailLogin.value, //also check with server if Email or Username is used
            passwordLogin: inpPasswordLogin.value            
        }

        let cfg = {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify(updata)
        }

        try{
            let resp = await fetch(url, cfg);
            let data = await resp.json();
            txtResultLogin.innerHTML = data.msg;
        }
        catch(err){
            console.log(err);
        }
    }

    //-----------------------------------------
    async function updateUser(){
        let url = "/user"; //need to get the userID from the server?
        
        let updata = {
            name: inpUserUpdate.value,
            email: inpEmailUpdate.value,
            password: inpPasswordUpdate.value
        }

        let cfg = {
            method: "PUT",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify(updata)
        }

        try{
            let resp = await fetch(url, cfg);
            let data = await resp.json();
            txtResultUpdate = data.msg;
        }
        catch(err){
            console.log(err);
        }
    }

    function validUsername(username){
        //username must be at least 3 characters long, consisting only of letters, numbers and underscores
        let regexUser = /^[^\W]{3,}$/;

        if(!regexUser.test(username.value)){
            return false;
        }
        return true;
    }

    function validEmail(email){
        //email starts with a letter, has letters/digits/'.'/'-'/'_', the last character before '@' is letter/digit
        //between '@' and '.' there are letters/digits/'.'/'-'/'_', first and last character are letter/digit
        //2 or 3 letters after '.', case intensive match (flagged with 'i')
        let regexEmail = /^[a-z][a-z0-9\.\_\-]+[a-z0-9]@[a-z0-9][a-z0-9\.\_\-]+[a-z0-9]\.[a-z]{2,3}$/i;
        if(!regexEmail.test(email.value)){
            return false;
        }
        return true;
    }

    function validPassword(password){
        //password must be at least 4 characters long; any character is allowed, except for empty space
        let regexPassword = /^[^\s]{4,}$/
        if(!regexPassword.test(password.value)){
            return false;
        }
        return true;
    }


</script>

</html>