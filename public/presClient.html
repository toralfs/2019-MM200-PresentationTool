<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presentation</title>
    <link rel="stylesheet" href="css/presOverview.css">
    <script src="js/userClient.js"></script>
    <script src="js/inputValidation.js"></script>
    <script src="js/presentationClient.js"></script>
</head>

<body>
    <template id="overviewTemp">
        <div class="overview-clickablediv">
            <h2 class="overview-presname"></h2>
            <p class="overview-slides">Slides: </p>
            <p class="overview-theme">Theme: </p>
            <p class="overview-public-status">Sharing: </p>
            <p class="overview-last-updated">Last updated: </p>
            <div class="overview-hiddenid" hidden="true"></div>
        </div>
    </template>

    <template id=edit-slideoverview-temp>
        <li class="edit-slideoverview"></li>
    </template>

    <template id="temp-slideA">
        <div class="slideA-container">
            <h1 class="title"></h1>
        </div>
    </template>

    <template id="temp-slideB">
        <div class="slideA-container">
            <!-- slide type b content -->
        </div>
    </template>

    <template id="temp-slideC">
        <div class="slideA-container">
            <!-- slide type c content -->
        </div>
    </template>


    <header>
        <a href="index.html" class="logo">
            <img class="logo" src="images/logo.svg" alt="logo">
        </a>
        <nav id="navbar">
            <ul class="nav__links">
                <li><a href="#overview" onclick="loadPresOverview(false)">My presentations</a></li>
                <li><a href="#overview" onclick="loadPresOverview(true)">Shared with me</a></li>
            </ul>
        </nav>
        <a class="cta" href="#">User</a>
        <p onclick="openNav()" class="menu cta">Menu</p>
    </header>

    <div id="mobile__menu" class="overlay">
        <a class="close" onclick="closeNav()">&times;</a>
        <div class="overlay__content">
            <a href="#overview" onclick="loadPresOverview(false), closeNav()">My presentations</a>
            <a href="#overview" onclick="loadPresOverview(true), closeNav()">Shared with me</a>
        </div>
    </div>

    <div id="container">
        <main>
            <div id="overview" class="page" style="display: none;">
                <h1></h1>
                <div id="presContainer"></div>
                <button id="overview-create-pres-btn" onclick=createPresentation()>&plus;</button>
            </div>

            <div id="editview" class="page" style="display: none;">
                <ul id="slide__list"></ul>
                <div id="editButtons">
                    <button id="add-slide">Add slide</button>
                    <button id="remove-slide">Remove slide</button>
                    <label for="theme-selection">Select theme: </label>
                    <select id="theme-selection">
                        <!-- Some options -->
                    </select>
                    <button id="updatePres" onclick="presentationClient.updateSlide()">Update</button>
                </div>

                <div id="selectedSlide">
                    <!-- contains slide from template -->
                </div>

            </div>
        </main>
    </div>
</body>

<script>
    let presOverview = document.getElementById("overview");
    let editView = document.getElementById("editview");
    let divSelectedSlide = document.getElementById("selectedSlide");

    // Script for mobile use - move to separate script eventually
    function openNav() {
        document.getElementById("mobile__menu").style.width = "100%";
    }

    function closeNav() {
        document.getElementById("mobile__menu").style.width = "0";
    }



    // --------------------------------------------------------------
    const HTTP_CODES = {
        OK: 200,
        CREATED: 201,
        BAD_REQUEST: 400,
        NOT_FOUND: 404,
        CONFLICT: 409
    }

    // ---------------- Presentations ---------------------------
    let userPresentations = [];

    let currentPres = {
        ID: "",
        owner: "",
        theme: ""
    }

    let selectedSlide = {
        ID: "",
        data: {}
    }

    userClient = new UserClient();
    presentationClient = new PresentationClient();

    function editPresentation(e) {
        let presID = parseInt(e.currentTarget.querySelector("div").innerText);

        let index = userPresentations.map(function (e) {
            return e.presentationid;
        }).indexOf(presID);

        currentPres.ID = userPresentations[index].presentationid;
        currentPres.owner = userPresentations[index].ownerid;
        currentPres.theme = userPresentations[index].theme;
        hideAllPages(); //This seems like a bad idea
        loadEditView(currentPres.ID);
    }


    async function loadEditView() {
        window.location.href = "#editview";
        editView.style.display = "block";
        let slideList = document.getElementById("slide__list");
        let slides = await presentationClient.getSlides(currentPres.ID);
        if (slides.code === HTTP_CODES.OK) {
            if (slides.data.length > 0) {
                for (let slide of slides.data) {
                    let tmp1 = document.getElementById("edit-slideoverview-temp").content.cloneNode(true);
                    tmp1.querySelector(".edit-slideoverview").innerText = `# ${slide.slideid}`;
                    slideList.appendChild(tmp1);
                }
                selectedSlide.ID = slides.data[0].slideid;
                selectedSlide.data = slides.data[0].data;

                updateActiveSlide(selectedSlide);
            } else {
                divSelectedSlide.innerHTML = "You have no slides yet";
            }
        }
    }

    function updateActiveSlide(slide) {
        let tmp1 = document.getElementById(`temp-slide${slide.data.type}`).content.cloneNode(true);

        tmp1.querySelector(".title").innerText = slide.data.title;
        divSelectedSlide.appendChild(tmp1);
    }


    async function loadPresOverview(isShared) {
        userPresentations = [];
        let presContainer = document.getElementById("presContainer");

        presOverview.style.display = "block"; //display style subject to change
        while (presContainer.firstChild) {
            presContainer.removeChild(presContainer.firstChild);
        }
        let presentations = null;
        if (isShared) {
            presentations = await presentationClient.getSharedWithMePresentations(3);
            presOverview.querySelector("h1").innerHTML = "Shared with me"
        } else {
            presentations = await presentationClient.getPresentations(1);
            presOverview.querySelector("h1").innerHTML = "My Presentations"
        }
        //need to transfer the ID of the current user (from local storage)
        if (presentations.code === HTTP_CODES.OK) {
            for (let presentation of presentations.presentations) {
                userPresentations.push(presentation);
                let tmp1 = document.getElementById('overviewTemp').content.cloneNode(true);

                tmp1.querySelector("div").addEventListener("click", function (e) {
                    editPresentation(e);
                });
                tmp1.querySelector(".overview-presname").innerText = presentation.name;
                tmp1.querySelector(".overview-slides").innerText += presentation.slides.length;
                tmp1.querySelector(".overview-theme").innerText += presentation.theme;
                tmp1.querySelector(".overview-hiddenid").innerText = presentation.presentationid;
                if (presentation.public == true) {
                    tmp1.querySelector(".overview-public-status").innerText += "Public";
                }
                else {
                    tmp1.querySelector(".overview-public-status").innerText += "Private";
                }

                let lastUpdated = presentationClient.splitTime(presentation.last_updated);

                tmp1.querySelector(".overview-last-updated").innerText += `${lastUpdated.date}, ${lastUpdated.clock}`;

                presContainer.appendChild(tmp1);
            }
        } else {
            presContainer.innerHTML = `Error ${presentations.code}, ${presentations.msg}`; //Should be a describing error message
        }

    }

    async function createPresentation() {
        let createdPres = await presentationClient.createPresentation("New presentation", currentUser.ID, "default");
        console.log(createdPres);
        if (createdPres.code === HTTP_CODES.CREATED) {
            //Load edit view with created presentation
        }
    }

    function hideAllPages() {
        presOverview.style.display = "none";
        editView.style.display = "none";
    }

</script>

</html>